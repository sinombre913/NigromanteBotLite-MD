import{dirname}from'path';import{fileURLToPath}from'url';import*as _0x3d7742 from'fs';import*as _0x1e977c from'path';import*as _0xf72a7f from'crypto';import{ffmpeg}from'./converter.js';import _0x3fb445 from'fluent-ffmpeg';import{spawn}from'child_process';import _0x162183 from'./uploadFile.js';import _0x8e8f4c from'./uploadImage.js';import{fileTypeFromBuffer}from'file-type';import _0x43b6bc from'node-webpmux';import _0x473c54 from'node-fetch';const __dirname=dirname(fileURLToPath(import.meta['url'])),tmp=_0x1e977c['join'](__dirname,'../tmp');function sticker2(_0x28fad2,_0x2485c3){return new Promise(async(_0x1e4426,_0x3a03d4)=>{try{if(_0x2485c3){const _0x3ef605=await _0x473c54(_0x2485c3);if(_0x3ef605['status']!==0xc8)throw await _0x3ef605['text']();_0x28fad2=await _0x3ef605['buffer']();}const _0x43094e=_0x1e977c['join'](tmp,+new Date()+'.jpeg');await _0x3d7742['promises']['writeFile'](_0x43094e,_0x28fad2);const _0x39a30c=spawn('ffmpeg',['-y','-i',_0x43094e,'-vf','scale=512:512:flags=lanczos:force_original_aspect_ratio=decrease,format=rgba,pad=512:512:(ow-iw)/2:(oh-ih)/2:color=#00000000,setsar=1','-f','png','-']);_0x39a30c['on']('error',_0x3a03d4),_0x39a30c['on']('close',async()=>{await _0x3d7742['promises']['unlink'](_0x43094e);});const _0x36f91d=[],[_0x3264e6,..._0x2d81cc]=[...module['exports']['support']['gm']?['gm']:module['exports']['magick']?['magick']:[],'convert','png:-','webp:-'],_0x3edf5c=spawn(_0x3264e6,_0x2d81cc);_0x3edf5c['on']('error',_0x122aa9=>conn['reply'](m['chat'],util['format'](_0x122aa9),m)),_0x3edf5c['stdout']['on']('data',_0x58b6e9=>_0x36f91d['push'](_0x58b6e9)),_0x39a30c['stdout']['pipe'](_0x3edf5c['stdin']),_0x3edf5c['on']('exit',()=>{_0x1e4426(Buffer['concat'](_0x36f91d));});}catch(_0xc49c87){_0x3a03d4(_0xc49c87);}});}async function sticker3(_0x3225df,_0xe5636b,_0x3831,_0xbbfa11){_0xe5636b=_0xe5636b?_0xe5636b:await _0x162183(_0x3225df);const _0x41f137=await _0x473c54('https://api.xteam.xyz/sticker/wm?'+new URLSearchParams(Object['entries']({'url':_0xe5636b,'packname':_0x3831,'author':_0xbbfa11})));return await _0x41f137['buffer']();}async function sticker4(_0x18ce5d,_0x371226){if(_0x371226){const _0x283953=await _0x473c54(_0x371226);if(_0x283953['status']!==0xc8)throw await _0x283953['text']();_0x18ce5d=await _0x283953['buffer']();}return await ffmpeg(_0x18ce5d,['-vf','scale=512:512:flags=lanczos:force_original_aspect_ratio=decrease,format=rgba,pad=512:512:(ow-iw)/2:(oh-ih)/2:color=#00000000,setsar=1'],'jpeg','webp');}async function sticker5(_0x33fc13,_0x136889,_0x3d799e,_0x240a58,_0x167ad5=[''],_0x29669d={}){const {Sticker:_0x35e399}=await import('wa-sticker-formatter'),_0x43d19f={'type':'default','pack':_0x3d799e,'author':_0x240a58,'categories':_0x167ad5,..._0x29669d};return new _0x35e399(_0x33fc13?_0x33fc13:_0x136889,_0x43d19f)['toBuffer']();}function sticker6(_0x117f0d,_0x2852cf){return new Promise(async(_0xedb1a,_0x5d0aab)=>{if(_0x2852cf){const _0x266887=await _0x473c54(_0x2852cf);if(_0x266887['status']!==0xc8)throw await _0x266887['text']();_0x117f0d=await _0x266887['buffer']();}const _0x238ee0=await fileTypeFromBuffer(_0x117f0d)||{'mime':'application/octet-stream','ext':'bin'};if(_0x238ee0['ext']=='bin')_0x5d0aab(_0x117f0d);const _0x390335=_0x1e977c['join'](__dirname,'../tmp/'+ +new Date()+'.'+_0x238ee0['ext']),_0x52fa62=_0x1e977c['join'](_0x390335+'.webp');await _0x3d7742['promises']['writeFile'](_0x390335,_0x117f0d);const _0x408407=/video/i['test'](_0x238ee0['mime'])?_0x3fb445(_0x390335)['inputFormat'](_0x238ee0['ext']):_0x3fb445(_0x390335)['input'](_0x390335);_0x408407['on']('error',function(_0x4555f5){console['error'](_0x4555f5),_0x3d7742['promises']['unlink'](_0x390335),_0x5d0aab(_0x117f0d);})['on']('end',async function(){_0x3d7742['promises']['unlink'](_0x390335),_0xedb1a(await _0x3d7742['promises']['readFile'](_0x52fa62));})['addOutputOptions'](['-vcodec','libwebp','-vf','scale=\x27min(320,iw)\x27:min\x27(320,ih)\x27:force_original_aspect_ratio=decrease,fps=15,\x20pad=320:320:-1:-1:color=white@0.0,\x20split\x20[a][b];\x20[a]\x20palettegen=reserve_transparent=on:transparency_color=ffffff\x20[p];\x20[b][p]\x20paletteuse'])['toFormat']('webp')['save'](_0x52fa62);});}async function addExif(_0x3a7b05,_0xebb96d,_0x13ad6c,_0x5cd603=[''],_0x199a29={}){const _0x48a498=new _0x43b6bc['Image'](),_0x3528af=_0xf72a7f['randomBytes'](0x20)['toString']('hex'),_0x566d38={'sticker-pack-id':_0x3528af,'sticker-pack-name':_0xebb96d,'sticker-pack-publisher':_0x13ad6c,'emojis':_0x5cd603,..._0x199a29},_0x3878f6=Buffer['from']([0x49,0x49,0x2a,0x0,0x8,0x0,0x0,0x0,0x1,0x0,0x41,0x57,0x7,0x0,0x0,0x0,0x0,0x0,0x16,0x0,0x0,0x0]),_0x4feb9c=Buffer['from'](JSON['stringify'](_0x566d38),'utf8'),_0x302bfa=Buffer['concat']([_0x3878f6,_0x4feb9c]);return _0x302bfa['writeUIntLE'](_0x4feb9c['length'],0xe,0x4),await _0x48a498['load'](_0x3a7b05),_0x48a498['exif']=_0x302bfa,await _0x48a498['save'](null);}async function sticker(_0x1a48e6,_0x45731c,..._0x32dea1){let _0x5ec24c,_0x2e731e;for(const _0x41714e of[sticker3,global['support']['ffmpeg']&&sticker6,sticker5,global['support']['ffmpeg']&&global['support']['ffmpegWebp']&&sticker4,global['support']['ffmpeg']&&(global['support']['convert']||global['support']['magick']||global['support']['gm'])&&sticker2]['filter'](_0x4ec821=>_0x4ec821)){try{_0x2e731e=await _0x41714e(_0x1a48e6,_0x45731c,..._0x32dea1);if(_0x2e731e['includes']('html'))continue;if(_0x2e731e['includes']('WEBP'))try{return await addExif(_0x2e731e,..._0x32dea1);}catch(_0x392cbe){return console['error'](_0x392cbe),_0x2e731e;}throw _0x2e731e['toString']();}catch(_0x565e95){_0x5ec24c=_0x565e95;continue;}}return console['error'](_0x5ec24c),_0x5ec24c;}const support={'ffmpeg':!![],'ffprobe':!![],'ffmpegWebp':!![],'convert':!![],'magick':![],'gm':![],'find':![]};export{sticker,sticker2,sticker3,sticker4,sticker6,addExif,support};